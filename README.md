# pw_UAV_Upper_Computer
在毕业设计中为四轴飞行器所设计的上位机调试app，使用蓝牙与主控进行通信

#### 数据帧相关说明：

数据帧大小固定为20字节

##### 帧格式
| 帧头 |操作码|   KP   |   KI   |   KD   | 高度  |反馈环id|  校验码 |    帧尾   |
|:----:|:---:|:------:|:------:|:------:|:-----:|:----:|:------:|:-:|
|[0:1] | [2] | [3:5]  | [6:8]  | [9:11] |[12:13]|[14:15]|[16:17]|[18:19]|
|0xfffe|0xAA |0x0ABCDE|0x0ABCDE|0x0ABCDE|0xAAAA |0x0000|0xAAAA|0xefff|
##### 帧头
固定为**0xfffe**
##### 操作码(暂定)
|0x01|0x02|0x04|0x08|0x10|0x20|0x40|0x80|
|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
|发送数据|启动|停止|前|后|左|右|空|
##### 参数
参数使用8421 BCD码发送，一个参数占3个字节
第一个字节的前四位是0，后四位是参数的百位
第二个字节的前后四位分别是参数的十位和个位
第三个字节的前后四位分别是参数的十分位和百分位
举例：假如说参数是12.34，数据就是0x001234

高度使用16进制数据，两个字节，单位是cm，范围从10cm~200cm
举例：假如说参数是123cm，数据就是0x007B
##### 反馈环id
用这个参数确定发送的PID参数应用到哪一个反馈环
##### 校验码
校验码只校验2到15字节，采用CRC16校验，相关代码如下
``` java
    //参数说明
    //data：待校验数据
    //num： 需要校验的大小
    //crc： crc初始值，一般来讲是0xffff
    //返回值：校验码
    private short crc16(byte[] data, int num, short crc){
        final int PLOY = 0x1021;
        for(int i = 0; i < num; i++){
            crc = (short) (crc^(data[i] << 8));
            for(int j = 0; j < 8; j++){
                if((crc & 0x8000) != 0){
                    crc = (short) ((crc << 1) ^ PLOY);
                } else {
                    crc <<= 1;
                }
                crc &= 0xffff;
            }
        }
        return crc;
    }
```
##### 帧尾
固定为**0xefff**
##### 例
如果发送参数为**KP=12.36, KI=1.25, KD=0.77, Height=20**, 发送数据:
**0xfffe 01 001236 000125 000077 0014 0000 d006 efff**, 共20字节

#### 后记
毕业前暂时告一段落，以后可能会增加新功能

虽然预期功能能达到，但是目前代码中还存在很多问题，有很多冗余，毕业后如果还有优化的打算会继续更新这个项目
